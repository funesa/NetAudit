{% extends "layout.html" %}
{% block title %}Mapa de IPs{% endblock %}
{% block page_title %}Mapa Inteligente de IPs{% endblock %}

{% block content %}
<style>
    .ip-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .stat-card {
        background: var(--bg-panel);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        border: 1px solid var(--border);
    }

    .stat-card.free {
        border-left-color: #10b981;
    }

    .stat-card.probably-free {
        border-left-color: #f59e0b;
    }

    .stat-card.in-use {
        border-left-color: #3b82f6;
    }

    .stat-card.online {
        border-left-color: #8b5cf6;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        margin: 8px 0;
    }

    .stat-label {
        color: var(--text-secondary);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .glass-panel {
        background: var(--bg-panel);
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        border: 1px solid var(--border);
        margin-bottom: 20px;
    }

    .ip-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 6px;
        margin-top: 20px;
        max-width: 100%;
        max-height: 70vh;
        /* Limit height and allow scroll inside grid if needed */
        overflow-y: auto;
    }

    .ip-cell {
        aspect-ratio: 1;
        padding: 8px 4px;
        border-radius: 6px;
        text-align: center;
        font-family: 'Courier New', monospace;
        font-size: 0.7rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .ip-cell:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 10;
    }

    .ip-cell.free {
        background: rgba(16, 185, 129, 0.1);
        color: #34d399;
        font-weight: 700;
    }

    .ip-cell.probably-free {
        background: rgba(245, 158, 11, 0.1);
        color: #fbbf24;
    }

    .ip-cell.in-use {
        background: rgba(59, 130, 246, 0.1);
        color: #60a5fa;
    }

    .ip-cell.online {
        background: rgba(139, 92, 246, 0.1);
        color: #a78bfa;
        font-weight: 700;
    }

    .ip-cell.selected {
        border-color: #7b68ee;
        box-shadow: 0 0 0 3px rgba(123, 104, 238, 0.3);
        transform: scale(1.15);
        z-index: 20;
    }

    .ip-details {
        background: var(--bg-hover);
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
        display: none;
        border: 1px solid var(--primary);
    }

    .ip-details.show {
        display: block;
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .legend {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        margin-bottom: 20px;
        padding: 12px;
        background: var(--bg-hover);
        border-radius: 8px;
        border: 1px solid var(--border);
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
    }

    .filter-bar {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .filter-bar select,
    .filter-bar input {
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 0.9rem;
    }

    .btn-suggest {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
    }

    .btn-suggest:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(123, 104, 238, 0.3);
    }

    /* Auto-refresh config */
    .auto-refresh-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        padding: 16px;
        color: white;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
    }

    .auto-refresh-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .auto-refresh-info i {
        font-size: 1.5rem;
    }

    .auto-refresh-controls {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }

    .auto-refresh-controls input,
    .auto-refresh-controls select {
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        font-size: 0.85rem;
    }

    .switch-ios {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 28px;
    }

    .switch-ios input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider-ios {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.3);
        transition: 0.4s;
        border-radius: 28px;
    }

    .slider-ios:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
    }

    input:checked+.slider-ios:before {
        transform: translateX(22px);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .filter-bar {
            flex-direction: column;
            align-items: stretch;
            gap: 12px;
        }

        .filter-bar input,
        .filter-bar select {
            width: 100% !important;
        }

        .btn-primary,
        .btn-suggest {
            width: 100%;
            justify-content: center;
        }

        .auto-refresh-card {
            flex-direction: column;
            align-items: flex-start;
        }

        .auto-refresh-controls {
            width: 100%;
            justify-content: space-between;
        }

        .ip-stats {
            grid-template-columns: 1fr;
        }
    }
</style>

<!-- Stats Cards -->
<div class="ip-stats">
    <div class="stat-card free">
        <div class="stat-label"><i class="ph ph-check-circle"></i> IPs Livres</div>
        <div class="stat-value" id="statFree">0</div>
    </div>

    <div class="stat-card probably-free">
        <div class="stat-label"><i class="ph ph-warning"></i> Provavelmente Livres</div>
        <div class="stat-value" id="statProbablyFree">0</div>
    </div>

    <div class="stat-card in-use">
        <div class="stat-label"><i class="ph ph-desktop"></i> Em Uso</div>
        <div class="stat-value" id="statInUse">0</div>
    </div>

    <div class="stat-card online">
        <div class="stat-label"><i class="ph ph-check-circle"></i> Online Agora</div>
        <div class="stat-value" id="statOnline">0</div>
    </div>
</div>

<!-- Auto-Refresh Configuration -->
<div class="auto-refresh-card">
    <div class="auto-refresh-info">
        <i class="ph-bold ph-clock-clockwise"></i>
        <div>
            <strong style="font-size: 1rem;">Atualiza√ß√£o Autom√°tica</strong>
            <div style="font-size: 0.85rem; opacity: 0.9;">Monitoramento inteligente de IPs livres</div>
        </div>
    </div>
    <div class="auto-refresh-controls">
        <input type="number" id="refreshInterval" value="5" min="1" max="60" style="width: 60px;">
        <select id="refreshUnit">
            <option value="minutes" selected>Minutos</option>
            <option value="hours">Horas</option>
        </select>
        <label class="switch-ios">
            <input type="checkbox" id="autoRefreshEnabled" onchange="toggleAutoRefresh()">
            <span class="slider-ios"></span>
        </label>
    </div>
</div>

<!-- Filters (Standardized) -->
<div class="control-container" style="background: transparent; border: none; box-shadow: none; padding: 0;">
    <div class="control-bar" style="justify-content: space-between; width: 100%;">
        <div style="display: flex; gap: 8px; align-items: center;">
            <div class="input-group"
                style="width: 250px; border-radius: 9999px; background: var(--bg-hover) !important; border: 1px solid var(--border) !important;">
                <i class="ph ph-network"></i>
                <input type="text" id="subnetInput" placeholder="Ex: 192.168.1.0/24" autocomplete="off"
                    style="color: var(--text-main) !important;">
            </div>

            <div
                style="display: flex; align-items: center; gap: 8px; background: var(--bg-hover); padding: 4px 12px; border-radius: 9999px; border: 1px solid var(--border);">
                <span style="font-size: 0.85rem; color: var(--text-secondary); font-weight: 600;">Dias sem uso:</span>
                <select id="daysThreshold"
                    style="border: none; background: transparent; font-weight: 600; color: var(--text-main); outline: none;">
                    <option value="1">1 dia</option>
                    <option value="3">3 dias</option>
                    <option value="7" selected>7 dias</option>
                    <option value="14">14 dias</option>
                    <option value="30">30 dias</option>
                </select>
            </div>
        </div>

        <div style="display: flex; gap: 8px;">
            <button class="btn-primary" onclick="loadIPMap()"
                style="height: 48px; border-radius: 9999px; padding: 0 24px;">
                <i class="ph-bold ph-arrows-clockwise"></i> Atualizar
            </button>

            <button class="btn-suggest" onclick="suggestIP()" style="height: 48px; border-radius: 9999px;">
                <i class="ph-bold ph-lightbulb"></i> Sugerir IP
            </button>

            <button onclick="testAPI()"
                style="height: 48px; border-radius: 9999px; padding: 0 20px; background: #10b981; color: white; border: none; cursor: pointer;">
                <i class="ph-bold ph-flask"></i> Teste Direto
            </button>

            <button onclick="toggleDebugPanel()"
                style="height: 48px; border-radius: 9999px; padding: 0 20px; background: #374151; color: white; border: none; cursor: pointer;">
                <i class="ph-bold ph-bug"></i> Debug
            </button>
        </div>
    </div>
</div>

<!-- Debug Panel -->
<div id="debugPanel"
    style="display: none; background: #1f2937; color: #10b981; padding: 20px; border-radius: 12px; margin-bottom: 20px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; border: 2px solid #10b981;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <strong style="color: #10b981; font-size: 14px;">üêõ PAINEL DE DEBUG</strong>
        <button onclick="clearDebugLog()"
            style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 11px;">
            Limpar
        </button>
    </div>
    <div id="debugLog" style="white-space: pre-wrap; word-wrap: break-word;"></div>
</div>

<!-- Main Panel -->
<div class="glass-panel">

    <!-- Legend -->
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: rgba(16, 185, 129, 0.2);"></div>
            <span>Livre (nunca usado)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: rgba(245, 158, 11, 0.2);"></div>
            <span>Provavelmente Livre (>X dias)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: rgba(59, 130, 246, 0.2);"></div>
            <span>Em Uso (visto recentemente)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: rgba(139, 92, 246, 0.2);"></div>
            <span>Online (hoje)</span>
        </div>
    </div>

    <!-- IP Grid -->
    <div id="ipGrid" class="ip-grid">
        <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #64748b;">
            Clique em Atualizar para carregar o mapa de IPs...
        </div>
    </div>

    <!-- IP Details -->
    <div id="ipDetails" class="ip-details">
        <h3 style="margin-top: 0; color: var(--text-main);">Detalhes do IP: <span id="detailIP">-</span></h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
            <div>
                <strong>Status:</strong> <span id="detailStatus">-</span>
            </div>
            <div>
                <strong>Hostname:</strong> <span id="detailHostname">-</span>
            </div>
            <div>
                <strong>MAC:</strong> <span id="detailMAC">-</span>
            </div>
            <div>
                <strong>√öltima Conex√£o:</strong> <span id="detailLastSeen">-</span>
            </div>
            <div>
                <strong>Tipo:</strong> <span id="detailType">-</span>
            </div>
            <div>
                <strong>Fabricante:</strong> <span id="detailManufacturer">-</span>
            </div>
        </div>
    </div>
</div>

<script>
    let allIPs = [];
    let selectedIP = null;

    async function loadIPMap() {
        const subnet = document.getElementById('subnetInput').value;
        const days = document.getElementById('daysThreshold').value;
        const grid = document.getElementById('ipGrid');

        grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px;"><i class="ph-bold ph-spinner-gap anim-spin" style="font-size: 2rem; color: var(--primary);"></i><br>Analisando hist√≥rico de IPs...</div>';

        try {
            const res = await fetch(`/api/ip-map?subnet=${encodeURIComponent(subnet)}&days=${days}`);
            const data = await res.json();

            allIPs = data.ips;
            renderIPGrid(allIPs);
            updateStats(data.stats);
        } catch (e) {
            console.error(e);
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: red;">Erro ao carregar mapa de IPs</div>';
        }
    }

    function renderIPGrid(ips) {
        const grid = document.getElementById('ipGrid');
        grid.innerHTML = '';

        ips.forEach(ip => {
            const cell = document.createElement('div');
            cell.className = `ip-cell ${ip.status}`;
            cell.textContent = ip.ip.split('.').slice(-1)[0]; // Mostrar apenas √∫ltimo octeto
            cell.title = `${ip.ip}\n${ip.hostname || 'Sem hostname'}\nStatus: ${ip.status}`;
            cell.onclick = () => showIPDetails(ip);
            grid.appendChild(cell);
        });
    }

    function showIPDetails(ip) {
        // Remover sele√ß√£o anterior
        document.querySelectorAll('.ip-cell').forEach(cell => cell.classList.remove('selected'));

        // Selecionar novo
        event.target.classList.add('selected');

        selectedIP = ip;

        document.getElementById('detailIP').textContent = ip.ip;
        document.getElementById('detailStatus').textContent = ip.status.replace('_', ' ').toUpperCase();
        document.getElementById('detailHostname').textContent = ip.hostname || 'N/A';
        document.getElementById('detailMAC').textContent = ip.mac || 'N/A';
        document.getElementById('detailLastSeen').textContent = ip.last_seen
            ? `${ip.last_seen_days} dia(s) atr√°s`
            : 'Nunca visto';
        document.getElementById('detailType').textContent = ip.device_type || 'Desconhecido';
        document.getElementById('detailManufacturer').textContent = ip.manufacturer || 'N/A';

        document.getElementById('ipDetails').classList.add('show');
    }

    function updateStats(stats) {
        document.getElementById('statFree').textContent = stats.free;
        document.getElementById('statProbablyFree').textContent = stats.probably_free;
        document.getElementById('statInUse').textContent = stats.in_use;
        document.getElementById('statOnline').textContent = stats.online;
    }

    // Debug Panel Functions
    function toggleDebugPanel() {
        const panel = document.getElementById('debugPanel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    function clearDebugLog() {
        document.getElementById('debugLog').innerHTML = '';
    }

    function debugLog(message, type = 'info') {
        const logDiv = document.getElementById('debugLog');
        const timestamp = new Date().toLocaleTimeString();
        const colors = {
            'info': '#10b981',
            'warn': '#f59e0b',
            'error': '#ef4444',
            'success': '#22c55e'
        };
        const color = colors[type] || colors['info'];

        logDiv.innerHTML += `<div style="color: ${color}; margin-bottom: 5px;">[${timestamp}] ${message}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;

        // Tamb√©m logar no console
        console.log(message);
    }

    // Fun√ß√£o de teste simples
    async function testAPI() {
        alert('üß™ Iniciando teste da API...');

        try {
            const url = '/api/ip-map/suggest?days=7';
            debugLog('üß™ TESTE: Chamando ' + url, 'info');

            const response = await fetch(url);
            const data = await response.json();

            debugLog('üß™ TESTE: Resposta recebida', 'success');
            debugLog(JSON.stringify(data, null, 2), 'info');

            if (data.error) {
                alert('‚ùå Erro: ' + data.error + '\n\n' + (data.message || ''));
            } else if (data.ip) {
                alert('‚úÖ Sucesso!\n\nIP Sugerido: ' + data.ip + '\nStatus: ' + data.status);
            } else {
                alert('‚ö†Ô∏è Resposta inesperada:\n\n' + JSON.stringify(data, null, 2));
            }
        } catch (e) {
            debugLog('üß™ TESTE: ERRO - ' + e.message, 'error');
            alert('‚ùå Erro no teste:\n\n' + e.message);
        }
    }

    async function suggestIP() {
        debugLog('================================================================================');
        debugLog('üîç INICIANDO SUGEST√ÉO DE IP', 'info');
        debugLog('================================================================================');

        const subnetInput = document.getElementById('subnetInput').value.trim();
        const days = document.getElementById('daysThreshold').value;

        debugLog('üìã Par√¢metros:');
        debugLog('  - Subnet: ' + (subnetInput || '(vazio - auto-detectar)'), 'info');
        debugLog('  - Dias sem uso: ' + days, 'info');

        try {
            // Construir URL
            let url = '/api/ip-map/suggest?days=' + days;
            if (subnetInput) {
                url += '&subnet=' + encodeURIComponent(subnetInput);
            }

            debugLog('üåê URL: ' + url, 'info');
            debugLog('‚è≥ Enviando requisi√ß√£o...', 'info');

            const res = await fetch(url);

            const statusMsg = 'üì° Status: ' + res.status + ' ' + res.statusText;
            debugLog(statusMsg, res.status === 200 ? 'success' : 'warn');

            const responseText = await res.text();
            debugLog('üìÑ Resposta (' + responseText.length + ' bytes)', 'info');

            let suggestion;
            try {
                suggestion = JSON.parse(responseText);
                debugLog('‚úÖ JSON parseado OK', 'success');
            } catch (parseError) {
                debugLog('‚ùå ERRO ao parsear JSON: ' + parseError.message, 'error');
                debugLog('Resposta: ' + responseText.substring(0, 200), 'error');
                alert('‚ùå Erro: Resposta inv√°lida do servidor\n\nResposta: ' + responseText.substring(0, 200));
                return;
            }

            if (suggestion.error) {
                debugLog('‚ö†Ô∏è API retornou erro: ' + suggestion.error, 'error');
                debugLog('   Mensagem: ' + suggestion.message, 'error');

                if (suggestion.traceback) {
                    debugLog('üìã Traceback: ' + suggestion.traceback, 'error');
                }

                const message = suggestion.message || suggestion.error;
                let errorMsg = '‚ùå ' + suggestion.error + '\n\n' + message;

                if (suggestion.traceback) {
                    errorMsg += '\n\n‚ö†Ô∏è Veja o painel de Debug para detalhes t√©cnicos';
                }

                alert(errorMsg);
            } else {
                debugLog('‚úÖ IP SUGERIDO: ' + suggestion.ip, 'success');
                debugLog('   Status: ' + suggestion.status, 'success');
                debugLog('   Hostname: ' + (suggestion.hostname || 'N/A'), 'success');

                showIPDetails(suggestion);

                // Destacar na grid
                const lastOctet = suggestion.ip.split('.').slice(-1)[0];
                document.querySelectorAll('.ip-cell').forEach(function (cell) {
                    if (cell.textContent === lastOctet) {
                        cell.classList.add('selected');
                        cell.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });

                alert('‚úÖ IP Sugerido: ' + suggestion.ip + '\n\nEste IP est√° livre e pode ser usado!');
            }
        } catch (e) {
            debugLog('üí• ERRO CR√çTICO: ' + e.name, 'error');
            debugLog('   Mensagem: ' + e.message, 'error');
            debugLog('   Stack: ' + e.stack, 'error');
            alert('‚ùå Erro ao sugerir IP\n\nDetalhes: ' + e.message + '\n\nClique no bot√£o Debug para ver mais informa√ß√µes.');
        }

        debugLog('================================================================================');
        debugLog('üèÅ FIM', 'info');
        debugLog('================================================================================');
    }

    // Auto-refresh functionality
    const enabled = document.getElementById('autoRefreshEnabled').checked;
    const interval = parseInt(document.getElementById('refreshInterval').value);
    const unit = document.getElementById('refreshUnit').value;

    // Save to localStorage
    localStorage.setItem('ipMapAutoRefresh', JSON.stringify({
        enabled: enabled,
        interval: interval,
        unit: unit
    }));

    if (enabled) {
        startAutoRefresh();
    } else {
        stopAutoRefresh();
    }
    }

    function startAutoRefresh() {
        stopAutoRefresh(); // Clear any existing timer

        const interval = parseInt(document.getElementById('refreshInterval').value);
        const unit = document.getElementById('refreshUnit').value;

        let milliseconds = interval * 60 * 1000; // Default to minutes
        if (unit === 'hours') {
            milliseconds = interval * 60 * 60 * 1000;
        }

        const enabled = document.getElementById('autoRefreshEnabled').checked;
        if (!enabled) return; // Prevent start if not checked

        console.log(`Auto-refresh iniciado: ${interval} ${unit}`);

        autoRefreshTimer = setInterval(() => {
            console.log('Atualizando mapa de IPs automaticamente...');
            loadIPMap();
        }, milliseconds);
    }

    function stopAutoRefresh() {
        if (autoRefreshTimer) {
            clearInterval(autoRefreshTimer);
            autoRefreshTimer = null;
            console.log('Auto-refresh parado');
        }
    }

    // Load saved settings on page load
    document.addEventListener('DOMContentLoaded', async function () {
        // Detectar e preencher subnet automaticamente
        try {
            const res = await fetch('/api/ip-map?days=7');
            const data = await res.json();

            if (data.stats && data.stats.subnet) {
                document.getElementById('subnetInput').value = data.stats.subnet;
                console.log('Subnet auto-preenchida:', data.stats.subnet);
            }
        } catch (e) {
            console.error('Erro ao detectar subnet:', e);
        }

        // Carregar mapa de IPs
        loadIPMap();

        // Load saved auto-refresh settings
        const saved = localStorage.getItem('ipMapAutoRefresh');
        if (saved) {
            try {
                const settings = JSON.parse(saved);
                document.getElementById('refreshInterval').value = settings.interval || 5;
                document.getElementById('refreshUnit').value = settings.unit || 'minutes';
                document.getElementById('autoRefreshEnabled').checked = settings.enabled || false;

                if (settings.enabled) {
                    startAutoRefresh();
                }
            } catch (e) {
                console.error('Erro ao carregar configura√ß√µes:', e);
            }
        }

        // Update auto-refresh when interval/unit changes
        document.getElementById('refreshInterval').addEventListener('change', function () {
            if (document.getElementById('autoRefreshEnabled').checked) {
                toggleAutoRefresh();
            }
        });

        document.getElementById('refreshUnit').addEventListener('change', function () {
            if (document.getElementById('autoRefreshEnabled').checked) {
                toggleAutoRefresh();
            }
        });
    });

</script>
{% endblock %}